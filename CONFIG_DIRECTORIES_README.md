# Configuration Directories Explanation

## Why Two Config Directories?

This firmware has TWO configuration directories with different purposes:

### `firmware/config/` - Hardware Configuration

**Purpose:** Low-level hardware settings that rarely change

**Contents:**
- `hardware_config.yaml` - GPIO pin mappings, I2C addresses, PWM frequencies
- `robot_config.yaml` - Physical robot specifications (dimensions, servo limits)
- `safety_config.yaml` - Safety thresholds (voltage limits, temperature limits)

**When to edit:**
- Setting up hardware for the first time
- Changing hardware components (different servo models, sensors)
- Adjusting safety margins based on testing

**Committed to git:** YES - These are reference configurations

---

### `firmware/configs/` - Runtime Configuration

**Purpose:** User-specific settings that change per deployment

**Contents:**
- `network_config.yaml` - WiFi credentials, hostname, SSH settings
- `sensor_calibration.yaml` - IMU calibration data (varies per device)
- `servo_limits.yaml` - Per-servo calibration (unique to each robot)
- `servo_calibration.yaml` - Generated by `calibrate_servos.py`

**When to edit:**
- Deploying to different WiFi networks
- After running calibration scripts
- Tuning individual servo behavior
- Setting up multiple robots with different names

**Committed to git:** TEMPLATES ONLY - Actual configs are in `.gitignore`

---

## Directory Structure Overview

```
firmware/
├── config/              # Hardware config (edit rarely)
│   ├── hardware_config.yaml
│   ├── robot_config.yaml
│   └── safety_config.yaml
│
├── configs/             # Runtime config (edit per deployment)
│   ├── network_config.yaml.example  (template)
│   ├── network_config.yaml          (your actual config, gitignored)
│   ├── sensor_calibration.yaml
│   ├── servo_limits.yaml
│   └── servo_calibration.yaml       (generated by scripts)
│
└── scripts/
    ├── calibrate_servos.py          (generates configs/)
    └── test_sensors.py              (validates config/)
```

---

## Which Directory Should I Use?

### Use `firmware/config/` for:
- Pin assignments (GPIO, I2C addresses)
- Hardware component specifications
- Safety thresholds (voltage, current, temperature)
- Default servo angles and ranges
- PWM frequency settings

### Use `firmware/configs/` for:
- WiFi passwords (NEVER commit!)
- Hostname and network settings
- Calibration data from your specific hardware
- Per-servo tuning parameters
- Runtime overrides

---

## Configuration Loading Order

The firmware loads configuration in this order (later configs override earlier):

1. `firmware/config/hardware_config.yaml` - Base hardware settings
2. `firmware/config/robot_config.yaml` - Robot specifications
3. `firmware/config/safety_config.yaml` - Safety limits
4. `firmware/configs/servo_limits.yaml` - Servo-specific limits
5. `firmware/configs/sensor_calibration.yaml` - Sensor calibration
6. `firmware/configs/network_config.yaml` - Network settings (optional)

---

## Security Notes

### Safe to Commit (Public Repository)
- `firmware/config/*` - Hardware specs, default values
- `firmware/configs/*.example` - Templates with placeholders

### NEVER Commit (Contains Secrets)
- `firmware/configs/network_config.yaml` - WiFi passwords
- `firmware/configs/*_local.yaml` - Any file with `_local` suffix
- Any file with actual API keys, passwords, or credentials

### Gitignore Protection

The `.gitignore` already protects sensitive configs:
```gitignore
# Protect user-specific configs
firmware/configs/network_config.yaml
firmware/configs/*_local.yaml
firmware/configs/servo_calibration.yaml
```

---

## Example Workflow

### First-Time Setup (New Robot)

1. **Review hardware config** (no changes needed for standard build)
   ```bash
   cat firmware/config/hardware_config.yaml
   cat firmware/config/safety_config.yaml
   ```

2. **Create network config from template**
   ```bash
   cp firmware/configs/network_config.yaml.example firmware/configs/network_config.yaml
   nano firmware/configs/network_config.yaml  # Edit WiFi credentials
   ```

3. **Run calibration**
   ```bash
   python3 firmware/scripts/calibrate_servos.py
   # Generates: firmware/configs/servo_calibration.yaml
   ```

4. **Test configuration**
   ```bash
   python3 firmware/scripts/test_sensors.py
   ```

### Deploying to Multiple Robots

Each robot gets its own `configs/` directory:

```bash
# Robot 1 (openduck-alpha)
firmware/configs/network_config.yaml  # hostname: openduck-alpha
firmware/configs/servo_calibration.yaml  # Calibrated for robot 1

# Robot 2 (openduck-beta)
firmware/configs/network_config.yaml  # hostname: openduck-beta
firmware/configs/servo_calibration.yaml  # Calibrated for robot 2
```

But both share the same `config/` (hardware specs are identical).

---

## Troubleshooting

### "Config file not found"
- Check you're in the right directory: `cd firmware`
- Verify file exists: `ls configs/`
- Create from template if missing: `cp configs/network_config.yaml.example configs/network_config.yaml`

### "Permission denied"
- Configs should be readable: `chmod 644 configs/*.yaml`
- Scripts should be executable: `chmod +x scripts/*.py`

### "Invalid configuration"
- Validate YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('configs/network_config.yaml'))"`
- Check for tabs (YAML requires spaces): `cat -A configs/network_config.yaml`

### "Calibration data not loaded"
- Run calibration first: `python3 scripts/calibrate_servos.py`
- Check output file was created: `ls -lh configs/servo_calibration.yaml`
- Verify file is valid YAML

---

## Migration Notes

### Legacy Single `config/` Directory

If you have an old version with only `config/`, migrate like this:

```bash
# Hardware configs stay in config/
mv config/hardware_config.yaml config/hardware_config.yaml
mv config/robot_config.yaml config/robot_config.yaml
mv config/safety_config.yaml config/safety_config.yaml

# Runtime configs move to configs/
mv config/network_config.yaml configs/network_config.yaml
mv config/sensor_calibration.yaml configs/sensor_calibration.yaml
mv config/servo_limits.yaml configs/servo_limits.yaml
```

---

## Summary

| Directory | Purpose | Examples | Commit to Git? |
|-----------|---------|----------|----------------|
| `config/` | Hardware specs | Pin maps, servo models | YES |
| `configs/` | Runtime settings | WiFi, calibration | Templates only |

**Rule of thumb:** If it contains passwords or calibration data unique to your robot, it goes in `configs/` and is gitignored.

---

**Last Updated:** 15 January 2026
**Config Version:** 1.0
**Compatible with:** OpenDuck Mini V3 firmware v1.0+
